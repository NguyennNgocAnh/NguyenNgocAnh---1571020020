@model List<Website.Model.Entities.AssetManagement>
@{
    ViewData["Title"] = "Trang Quản Lý Tài Sản";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/asset.css" asp-append-version="true" />
</head>
<body>
    <div class="container">
        @{
            decimal tongGoc = 0;
            decimal tongNAV = 0;

            foreach (var taiSan in Model)
            {
                // Xử lý null và định dạng 2 chữ số thập phân
                decimal buyPrice = taiSan.BuyPrice;
                decimal sellPrice = taiSan.SellPrice ?? 0;
                tongGoc += taiSan.Quantity * buyPrice;
                tongNAV += taiSan.Quantity * sellPrice;
            }

            decimal tangTruong = tongGoc > 0 ? ((tongNAV - tongGoc) / tongGoc) * 100 : 0;
        }

        <div class="d-flex flex-wrap justify-content-center align-items-center gap-5 mb-3 fw-bold text-center">
            <div>📄 Danh sách tài sản: @Model.Count</div>
            <div>💰 Tổng tài sản gốc: @tongGoc.ToString("N0") VNĐ</div>
            <div>📈 NAV: @tongNAV.ToString("N0") VNĐ</div>
            <div class="@(tangTruong >= 0 ? "text-success" : "text-danger")">
                📊 Tăng trưởng: @tangTruong.ToString("0.##")%
            </div>
            <div class="text-dark">
                🔍 Tổng lãi/lỗ hiện tại: <b>@(ViewBag.TotalProfitLossNow ?? "0.00")</b>
            </div>
        </div>
        <div id="futureProfitLoss" style="display: none;" class="alert alert-info fw-bold shadow-sm rounded">
            <span>Dự đoán tổng lãi/lỗ tương lai:</span>
            <span class="text-primary ms-2">@(ViewBag.TotalProfitLossFuture ?? "0.00")</span>
        </div>
        <div class="d-flex align-items-center flex-wrap mb-3" style="gap: 20px;">
            <button type="button" class="btn btn-primary" onclick="toggleFutureProfit()">Dự đoán lãi/lỗ</button>

            <form method="get" asp-controller="AssetManagement" asp-action="Index" class="d-flex align-items-center flex-wrap" style="gap: 10px; margin: 0;">
                <div class="d-flex align-items-center" style="gap: 5px;">
                    <label for="startDate" class="mb-0">Từ ngày:</label>
                    <input type="date" name="startDate" id="startDate" class="form-control" style="width: 150px;" />
                </div>

                <div class="d-flex align-items-center" style="gap: 5px;">
                    <label for="endDate" class="mb-0">Đến ngày:</label>
                    <input type="date" name="endDate" id="endDate" class="form-control" style="width: 150px;" />
                </div>

                <button type="submit" class="btn btn-primary">Lọc</button>
            </form>
            <a href="/AssetManagement/ExportToExcel" class="btn btn-primary">Báo cáo tài sản</a>

            <form method="get" action="@Url.Action("Index", "AssetManagement")" class="d-flex align-items-center" style="gap: 10px;">
                <input type="text" id="searchInput" name="searchKeyword" placeholder="Nhập mã tài sản (ví dụ: FPT)" class="form-control" style="width: 200px;" value="@Context.Request.Query["searchKeyword"]" />
                <button type="submit" class="btn btn-primary ms-2">
                    <i class="fas fa-search"></i> Tìm kiếm
                </button>
            </form>
        </div>

        <div class="row">
            <div class="col-md-12">
                <!-- Bảng danh sách tài sản -->
                <table class="table table-bordered">
                    <thead class="table-custom-blue">
                        <tr>
                            <th>Mã tài sản</th>
                            <th>Tên tài sản</th>
                            <th>Hành động</th>
                            <th>Số lượng</th>
                            <th>Giá Mua</th>
                            <th>Giá Bán</th>
                            <th>Lãi/Lỗ +/-</th>
                            <th>Ngày thực hiện</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="assetTable">
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <a href="#" class="asset-code" data-stockid="@item.StockId.GetValueOrDefault()">@item.AssetCode</a>
                                </td>
                                <td>@item.AssetName</td>
                                <td>@item.Action</td>
                                <td>@item.Quantity</td>
                                <td>@(item.BuyPrice.ToString("F2"))</td>
                                <td>@(item.SellPrice?.ToString("F2") ?? "0.00")</td>
                                <td class="@(item.ProfitLoss >= 0 ? "text-success" : "text-danger")">
                                    @(item.ProfitLoss?.ToString("F2") ?? "0.00")
                                </td>
                                <td><script>document.write(new Date('@item.ActionDate').toLocaleDateString('vi-VN'));</script></td>
                                <td>
                                    <a href="/AssetManagement/Edit/@item.AssetId"><i class="fa-solid fa-edit"></i></a>
                                    <a href="/AssetManagement/Delete/@item.AssetId" onclick="return confirm('Bạn có chắc là muốn xóa không?');"><i class="fas fa-trash"></i></a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div id="priceDetailModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" id="priceDetailContent">
                            <!-- Nội dung bảng giá sẽ được load vào đây -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container biểu đồ cho responsive và dễ chỉnh sửa -->
            <div class="row mt-4">
                <div class="col-6">
                    <div class="chart-container" style="height: 500px; padding: 10px;">
                        <div class="chart-title">Biểu đồ % Lãi/Lỗ theo Tài Sản</div>
                        <canvas id="profitLossChart"></canvas>
                    </div>
                </div>
                <div class="col-6">
                    <div class="chart-container" style="height: 500px; padding: 10px;">
                        <div class="chart-title">Biểu đồ Tỉ Lệ Giao Dịch theo Ngày</div>
                        <canvas id="transactionRatioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        @* Chuẩn bị dữ liệu cho biểu đồ *@
        @{
            var tenTaiSan = new List<string>();
            var laiLoPhanTram = new List<decimal>();
            var laiPhanTram = new List<decimal>();
            var loPhanTram = new List<decimal>();

            foreach (var item in Model)
            {
                tenTaiSan.Add(item.AssetCode ?? "Không xác định");
                decimal buyPrice = item.BuyPrice;
                decimal sellPrice = item.SellPrice ?? 0;
                decimal goc = item.Quantity * buyPrice;
                decimal nav = item.Quantity * sellPrice;
                var tile = goc > 0 ? ((nav - goc) / goc) * 100 : 0;
                laiLoPhanTram.Add(Math.Round(tile, 2));
                if (tile >= 0)
                {
                    laiPhanTram.Add(Math.Round(tile, 2));
                    loPhanTram.Add(0);
                }
                else
                {
                    laiPhanTram.Add(0);
                    loPhanTram.Add(Math.Round(Math.Abs(tile), 2));
                }
            }

            var tenTaiSanJson = System.Text.Json.JsonSerializer.Serialize(tenTaiSan);
            var laiLoJson = System.Text.Json.JsonSerializer.Serialize(laiLoPhanTram);
            var laiJson = System.Text.Json.JsonSerializer.Serialize(laiPhanTram);
            var loJson = System.Text.Json.JsonSerializer.Serialize(loPhanTram);

            var transactionDatesJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.TransactionDates);
            var transactionQuantitiesJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.TransactionQuantities);
        }
    </div>
    <section class="mb-5">
        <h2 class="section-title">Bảng chứng khoán</h2>
        <div class="row">
            <!-- Cột trái: Bảng chứng khoán -->
            <div class="col-md-6">
                <!-- thêm div này -->
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Tên</th>
                            <th>Thay đổi</th>
                            <th>Ngành</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var stock in ViewBag.StockList)
                        {
                            <tr>
                                <td>
                                    <a href="@Url.Action("Create", "AlertView", new { stockId = stock.StockId })">
                                        @stock.StockName
                                    </a>
                                </td>
                                <td class="
                                @{
                                    decimal exchangeValue = 0;
                                    if (decimal.TryParse(stock.Exchange?.Replace("+", "").Replace("-", ""), out decimal result))
                                    {
                                        exchangeValue = result;
                                    }
                                        @(exchangeValue >= 0 ? "text-success" : "text-danger")
                                }">
                                    @stock.Exchange
                                </td>
                                <td>@stock.Industry?.IndustryName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Cột phải: Form lọc lịch sử giao dịch -->
            <div class="col-6">
                <!-- Lọc lịch sử giao dịch -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Lịch sử giao dịch</h5>
                        <form id="historyFilterForm" method="post" action="@Url.Action("History", "AssetManagement")">
                            <div class="row">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-4">
                                            <label for="startDate">Từ ngày</label>
                                            <input type="date" name="startDate" class="form-control" />
                                        </div>
                                        <div class="col-4">
                                            <label for="endDate">Đến ngày</label>
                                            <input type="date" name="endDate" class="form-control" />
                                        </div>
                                        <div class="col-4">
                                            <label for="searchKeyword">Mã chứng khoán</label>
                                            <select name="searchKeyword" class="form-control">
                                                <option value="">-- Chọn mã --</option>
                                                @{
                                                    // Lấy danh sách các mã chứng khoán duy nhất mà người dùng đã mua từ Model
                                                    var purchasedAssetCodes = Model.Select(a => a.AssetCode).Distinct().ToList();

                                                    if (ViewBag.StockList != null)
                                                    {
                                                        foreach (var stock in ViewBag.StockList)
                                                        {
                                                            // Chỉ hiển thị các mã chứng khoán mà người dùng đã mua
                                                            if (purchasedAssetCodes.Contains(stock.StockName))
                                                            {
                                                                <option value="@stock.StockName">@stock.StockName</option>
                                                            }
                                                        }
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 text-right">
                                <button type="submit" class="btn btn-primary">Lọc</button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Show lịch sử -->
                <div id="historyResult" class="mt-3">
                    <!-- Kết quả sẽ được load vào đây -->
                </div>
            </div>
        </div>
        <!-- Modal hiển thị giá thị trường -->
        <div class="modal fade" id="marketModal" tabindex="-1" aria-labelledby="marketModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <!-- modal rộng -->
                <div class="modal-content">
                    <div class="modal-body" id="marketModalBody">
                        <div class="text-center">Đang tải dữ liệu...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
        function toggleFutureProfit() {
            const div = document.getElementById("futureProfitLoss");
            if (div.style.display === "none") {
                div.style.display = "block";
            } else {
                div.style.display = "none";
            }
        }

        // Biểu đồ 1: % Lãi/Lỗ theo Tài Sản (Line Chart với 2 đường)
        const ctx1 = document.getElementById('profitLossChart').getContext('2d');
        const profitLossChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: @Html.Raw(tenTaiSanJson),
                datasets: [
                    {
                        label: 'Lãi (%)',
                        data: @Html.Raw(laiJson),
                        borderColor: 'rgba(0, 128, 0, 1)', // Màu xanh lá cây cho lãi
                        backgroundColor: 'rgba(0, 128, 0, 0.2)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    },
                    {
                        label: 'Lỗ (%)',
                        data: @Html.Raw(loJson),
                        borderColor: 'rgba(255, 0, 0, 1)', // Màu đỏ cho lỗ
                        backgroundColor: 'rgba(255, 0, 0, 0.2)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Phần trăm (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Mã Tài Sản'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '%';
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // Biểu đồ 2: Tỉ Lệ Giao Dịch theo Ngày (Line Chart)
        const ctx2 = document.getElementById('transactionRatioChart').getContext('2d');
        const transactionRatioChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: @Html.Raw(transactionDatesJson),
                datasets: [{
                    label: 'Số Lượng Giao Dịch',
                    data: @Html.Raw(transactionQuantitiesJson),
                    borderColor: '#08306b',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Số Lượng Giao Dịch'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Ngày Giao Dịch'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    </script>
    @section Scripts {
        <script>
            $(document).ready(function () {
                $('#historyFilterForm').submit(function (e) {
                    e.preventDefault(); // Ngăn submit form bình thường

                    $.ajax({
                        type: 'POST',
                        url: $(this).attr('action'),
                        data: $(this).serialize(),
                        success: function (result) {
                            $('#historyResult').html(result); // Hiển thị kết quả vào div
                        },
                        error: function () {
                            $('#historyResult').html('<div class="alert alert-danger">Không thể tải dữ liệu.</div>');
                        }
                    });
                });
            });
        </script>
    }
    <script>
        $('.asset-code').click(function (e) {
            e.preventDefault();
            var stockId = $(this).data('stockid');
            console.log("StockId click:", stockId); // debug

            $.ajax({
                url: '/AssetManagement/GetMarketPrices',
                type: 'GET',
                data: { stockId: stockId },
                success: function (result) {
                    $('#marketModalBody').html(result);
                    $('#marketModal').modal('show');
                },
                error: function () {
                    $('#marketModalBody').html('<div class="alert alert-danger">Không thể tải bảng giá.</div>');
                    $('#marketModal').modal('show');
                }
            });
        });
    </script>

</body>
</html>